<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mesh &mdash; Parthenon  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Domain" href="domain.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Parthenon
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../README.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../amr.html">Adaptive Mesh Refinement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../boundary_communication.html">Boundary communication-in-one concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../boundary_communication.html#sparse-boundary-communication">Sparse boundary communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../boundary_conditions.html">Boundary Conditions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../building.html">Building Parthenon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts_lite.html">C++11 Style Concepts Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../constants.html">Parthenon Built-in Physical Constants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coordinates.html">Coordinates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development.html">Parthenon developer guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../driver.html">Application Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inputs.html">Input Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../instrumentation.html">Performance Instrumentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../integrators.html">Integrators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../load_balancing.html">Load Balancing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nested_par_for.html">Nested Parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../outputs.html">Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parthenon_arrays.html">Parthenon Set-Dimensional Arrays</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parthenon_arrays.html#parthenon-arbitrary-dimensional-arrays">Parthenon Arbitrary-Dimensional Arrays</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parthenon_manager.html">Parthenon Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../particles.html">Particles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reductions.html">Task-based reductions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../solvers.html">Solvers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sphinx-doc.html">How to Use Sphinx for Writing Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tasks.html">Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tests.html">How to add tests to Parthenon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../weak_scaling.html">Running a Weak Scaling Test in Parthenon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../interface/boundary.html">Boundary related classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../interface/containers.html">Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../interface/metadata.html">Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../interface/refinement_operations.html">Prolongation and Restriction Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../interface/sparse.html">Sparse implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../interface/state.html">State Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="domain.html">Domain</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Mesh</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#looping-over-meshblocks">Looping over MeshBlocks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mesh-functions-controlling-evolulution-and-diagnostics">Mesh Functions Controlling Evolulution and Diagnostics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#multi-grid-grids-stored-in-mesh">Multi-grid Grids Stored in <code class="docutils literal notranslate"><span class="pre">Mesh</span></code></a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Parthenon</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Mesh</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/src/mesh/mesh.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="mesh">
<h1>Mesh<a class="headerlink" href="#mesh" title="Link to this heading"></a></h1>
<p>The mesh object represents the mesh on a given processor/MPI rank. There
is one mesh per processor. The <code class="docutils literal notranslate"><span class="pre">Mesh</span></code> object owns all <code class="docutils literal notranslate"><span class="pre">MeshBlock</span></code>s
on a given processor.</p>
<section id="looping-over-meshblocks">
<h2>Looping over MeshBlocks<a class="headerlink" href="#looping-over-meshblocks" title="Link to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">MeshBlock</span></code>s are stored in a variable <code class="docutils literal notranslate"><span class="pre">Mesh::block_list</span></code>, which is
an object of type</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">BlockList_t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">MeshBlock</span><span class="o">&gt;&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>and so to get the predicted time step for each mesh block, you can call:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pmb</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">pmesh</span><span class="o">-&gt;</span><span class="n">block_list</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">NewDt</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">pmesh</span></code> is a pointer to a <code class="docutils literal notranslate"><span class="pre">Mesh</span></code> object. This paradigm may
appear, for example, in an application driver.</p>
</section>
<section id="mesh-functions-controlling-evolulution-and-diagnostics">
<h2>Mesh Functions Controlling Evolulution and Diagnostics<a class="headerlink" href="#mesh-functions-controlling-evolulution-and-diagnostics" title="Link to this heading"></a></h2>
<p>Some mesh functions are stored as <code class="docutils literal notranslate"><span class="pre">std::function</span></code> members and are
called by the <code class="docutils literal notranslate"><span class="pre">EvolutionDriver</span></code>. They may be overridden by the
application by reassigning the default values of the <code class="docutils literal notranslate"><span class="pre">std::function</span></code>
member.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PreStepUserWorkInLoop(Mesh*,</span> <span class="pre">ParameterInput*,</span> <span class="pre">SimTime</span> <span class="pre">const&amp;)</span></code> is
called to perform mesh-wide work <em>before</em> the time-integration advance
(the default is a no-op)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PostStepUserWorkInLoop(Mesh*,</span> <span class="pre">ParameterInput*,</span> <span class="pre">SimTime</span> <span class="pre">const&amp;)</span></code> is
called to perform mesh-wide work <em>after</em> the time-integration advance
(the default is a no-op)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PreStepUserDiagnosticsInLoop(Mesh*,</span> <span class="pre">ParameterInput*,</span> <span class="pre">SimTime</span> <span class="pre">const&amp;)</span></code>
is called to perform diagnostic calculations and/or edits <em>before</em> the
time-integration advance. The default behavior calls to each package’s
(StateDesrcriptor’s) <code class="docutils literal notranslate"><span class="pre">PreStepDiagnostics</span></code> method which, in turn,
delegates to a <code class="docutils literal notranslate"><span class="pre">std::function</span></code> member that defaults to a no-op.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PostStepUserDiagnosticsInLoop(Mesh*,</span> <span class="pre">ParameterInput*,</span> <span class="pre">SimTime</span> <span class="pre">const&amp;)</span></code>
is called to perform diagnostic calculations and/or edits <em>after</em> the
time-integration advance. The default behavior calls to each package’s
(StateDesrcriptor’s) <code class="docutils literal notranslate"><span class="pre">PreStepDiagnostics</span></code> method which, in turn,
delegates to a <code class="docutils literal notranslate"><span class="pre">std::function</span></code> member that defaults to a no-op.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">UserMeshWorkBeforeOutput(Mesh*,</span> <span class="pre">ParameterInput*,</span> <span class="pre">SimTime</span> <span class="pre">const&amp;)</span></code>
is called to perform mesh-wide work immediately before writing an output
(the default is a no-op). The most likely use case is to fill derived
fields with updated values before writing them out to disk (or passing
them to Ascent for in-situ analysis).</p></li>
</ul>
</section>
<section id="multi-grid-grids-stored-in-mesh">
<h2>Multi-grid Grids Stored in <code class="docutils literal notranslate"><span class="pre">Mesh</span></code><a class="headerlink" href="#multi-grid-grids-stored-in-mesh" title="Link to this heading"></a></h2>
<p>If the parameter <code class="docutils literal notranslate"><span class="pre">parthenon/mesh/multigrid</span></code> is set to <code class="docutils literal notranslate"><span class="pre">true</span></code>, the <code class="docutils literal notranslate"><span class="pre">Mesh</span></code>
constructor and AMR routines populate both
<code class="docutils literal notranslate"><span class="pre">std::vector&lt;LogicalLocMap_t&gt;</span> <span class="pre">Mesh::gmg_grid_locs</span></code> and
<code class="docutils literal notranslate"><span class="pre">std::vector&lt;BlockList_t&gt;</span> <span class="pre">gmg_block_lists</span></code>, where each entry into the vectors
describes one level of the of the geometric multi-grid (GMG) mesh. For refined
meshes, each GMG level only includes blocks that are at a given logical level
(starting from the finest logical level on the grid and including both internal
and leaf nodes in the refinement tree) as well as leaf blocks on the next coarser
level that are neighbors to finer blocks, which implies that below the root grid
level the blocks may not cover the entire mesh. For levels above the root grid,
blocks may change shape so that they only cover the domain of the root grid. Note
that leaf blocks may be contained in multiple blocklists, and the lists all point
to the same block (not a separate copy). To be explicit, when
<code class="docutils literal notranslate"><span class="pre">parthenon/mesh/multigrid</span></code> is set to <code class="docutils literal notranslate"><span class="pre">true</span></code> blocks corresponding to <em>all</em>
internal nodes of the refinement tree are created, in addition to the leaf node blocks
that are normally created.</p>
<p><em>GMG Implementation Note:</em>
The reason for including two levels in the GMG block lists is for dealing with
accurately setting the boundary values of the fine blocks. Convergence can be poor
or non-exististent if the fine-coarse boundaries of a given level are not
self-consistently updated (since the boundary prolongation from the coarse grid to
the fine grid also depends on interior values of the fine grid that are being updated
by a smoothing operation). This means that each smoothing step, boundary communication
must occur between all blocks corresponding to all internal and leaf nodes at a given
level in the tree and with all leaf nodes at the next coarser level which abut blocks
at the current level. Therefore, the GMG block lists contain blocks at two levels, but
smoothing operations etc. should usually only occur on the subset of those blocks that
are at the fine level.</p>
<p>To work with these GMG levels, <code class="docutils literal notranslate"><span class="pre">MeshData</span></code> objects containing these blocks can
be recovered from a <code class="docutils literal notranslate"><span class="pre">Mesh</span></code> pointer using</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pmesh</span><span class="o">-&gt;</span><span class="n">gmg_mesh_data</span><span class="p">[</span><span class="n">level</span><span class="p">].</span><span class="n">GetOrAdd</span><span class="p">(</span><span class="n">level</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;base&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">partition_idx</span><span class="p">);</span>
</pre></div>
</div>
<p>This <code class="docutils literal notranslate"><span class="pre">MeshData</span></code> will include blocks at the current level and possibly some
blocks at the next coarser level. Often, one will only want to operate on blocks
on the finer level (the coarser blocks are required mainly for boundary
communication). To make packs containing only a subset of blocks from a
GMG <code class="docutils literal notranslate"><span class="pre">MeshData</span></code> pointer <code class="docutils literal notranslate"><span class="pre">md</span></code>, one would use</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">nblocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">md</span><span class="o">-&gt;</span><span class="n">NumBlocks</span><span class="p">();</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">include_block</span><span class="p">(</span><span class="n">nblocks</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nblocks</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="n">include_block</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">grid</span><span class="p">.</span><span class="n">logical_level</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">md</span><span class="o">-&gt;</span><span class="n">GetBlockData</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GetBlockPointer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">loc</span><span class="p">.</span><span class="n">level</span><span class="p">());</span>

<span class="k">auto</span><span class="w"> </span><span class="n">desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parthenon</span><span class="o">::</span><span class="n">MakePackDescriptor</span><span class="o">&lt;</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="o">&gt;</span><span class="p">(</span><span class="n">md</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="k">auto</span><span class="w"> </span><span class="n">pack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">desc</span><span class="p">.</span><span class="n">GetPack</span><span class="p">(</span><span class="n">md</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="n">include_block</span><span class="p">);</span>
</pre></div>
</div>
<p>In addition to creating the <code class="docutils literal notranslate"><span class="pre">LogicalLocation</span></code> and block lists for the GMG levels,
<code class="docutils literal notranslate"><span class="pre">Mesh</span></code> fills neighbor arrays in <code class="docutils literal notranslate"><span class="pre">MeshBlock</span></code> for intra- and inter-GMG block list
communication (i.e. boundary communication and internal prolongation/restriction,
respectively). Communication within and between GMG levels can be done by calling
boundary communication routines with the boundary tags <code class="docutils literal notranslate"><span class="pre">gmg_same</span></code>,
<code class="docutils literal notranslate"><span class="pre">gmg_restrict_send</span></code>, <code class="docutils literal notranslate"><span class="pre">gmg_restrict_recv</span></code>, <code class="docutils literal notranslate"><span class="pre">gmg_prolongate_send</span></code>,
<code class="docutils literal notranslate"><span class="pre">gmg_prolongate_recv</span></code> (see <a class="reference internal" href="../boundary_communication.html#boundary-comm-tasks"><span class="std std-ref">Boundary Communication Tasks</span></a>).</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="domain.html" class="btn btn-neutral float-left" title="Domain" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, The Parthenon Collaboration and Triad National Security.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: develop
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Branches</dt>
      <dd><a href="mesh.html">develop</a></dd>
      <dd><a href="../../../acreyes/div-free-prolong/src/mesh/mesh.html">acreyes/div-free-prolong</a></dd>
      <dd><a href="../../../acreyes/edge-flux-pack/src/mesh/mesh.html">acreyes/edge-flux-pack</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>