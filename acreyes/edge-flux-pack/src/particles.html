<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Particles &mdash; Parthenon  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Task-based reductions" href="reductions.html" />
    <link rel="prev" title="Parthenon Manager" href="parthenon_manager.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Parthenon
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="README.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="amr.html">Adaptive Mesh Refinement</a></li>
<li class="toctree-l1"><a class="reference internal" href="boundary_communication.html">Boundary communication-in-one concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="boundary_communication.html#sparse-boundary-communication">Sparse boundary communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="boundary_conditions.html">Boundary Conditions</a></li>
<li class="toctree-l1"><a class="reference internal" href="building.html">Building Parthenon</a></li>
<li class="toctree-l1"><a class="reference internal" href="concepts_lite.html">C++11 Style Concepts Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="constants.html">Parthenon Built-in Physical Constants</a></li>
<li class="toctree-l1"><a class="reference internal" href="coordinates.html">Coordinates</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Parthenon developer guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="driver.html">Application Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="inputs.html">Input Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation.html">Performance Instrumentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="integrators.html">Integrators</a></li>
<li class="toctree-l1"><a class="reference internal" href="load_balancing.html">Load Balancing</a></li>
<li class="toctree-l1"><a class="reference internal" href="nested_par_for.html">Nested Parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="outputs.html">Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="parthenon_arrays.html">Parthenon Set-Dimensional Arrays</a></li>
<li class="toctree-l1"><a class="reference internal" href="parthenon_arrays.html#parthenon-arbitrary-dimensional-arrays">Parthenon Arbitrary-Dimensional Arrays</a></li>
<li class="toctree-l1"><a class="reference internal" href="parthenon_manager.html">Parthenon Manager</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Particles</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#swarms">Swarms</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parallel-dispatch">Parallel Dispatch</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sorting">Sorting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#defragmenting">Defragmenting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#swarmcontainer">SwarmContainer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#particles-example"><code class="docutils literal notranslate"><span class="pre">particles</span></code> Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#communication">Communication</a></li>
<li class="toctree-l2"><a class="reference internal" href="#variable-packing">Variable Packing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#swarmpack-s">``SwarmPack``s</a></li>
<li class="toctree-l2"><a class="reference internal" href="#boundary-conditions">Boundary conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#outputs">Outputs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="reductions.html">Task-based reductions</a></li>
<li class="toctree-l1"><a class="reference internal" href="solvers.html">Solvers</a></li>
<li class="toctree-l1"><a class="reference internal" href="sphinx-doc.html">How to Use Sphinx for Writing Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks.html">Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="tests.html">How to add tests to Parthenon</a></li>
<li class="toctree-l1"><a class="reference internal" href="weak_scaling.html">Running a Weak Scaling Test in Parthenon</a></li>
<li class="toctree-l1"><a class="reference internal" href="interface/boundary.html">Boundary related classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="interface/containers.html">Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="interface/metadata.html">Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="interface/refinement_operations.html">Prolongation and Restriction Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="interface/sparse.html">Sparse implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="interface/state.html">State Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="mesh/domain.html">Domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="mesh/mesh.html">Mesh</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Parthenon</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Particles</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/src/particles.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="particles">
<h1>Particles<a class="headerlink" href="#particles" title="Link to this heading"></a></h1>
<p>Parthenon provides a data framework for particle methods that allows for
Kokkos accelerated parallel dispatch of compute operations. Particle
memory is allocated as a separate pool for each variable in the
particle.</p>
<section id="swarms">
<h2>Swarms<a class="headerlink" href="#swarms" title="Link to this heading"></a></h2>
<p>A <code class="docutils literal notranslate"><span class="pre">Swarm</span></code> contains all the particle data for all particles of a given
species. It owns a set of <code class="docutils literal notranslate"><span class="pre">ParticleVariable</span></code>s, one for each value of
each particle. For example, the spatial positions <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, and
<code class="docutils literal notranslate"><span class="pre">z</span></code> of the particles in a swarm are three separate
<code class="docutils literal notranslate"><span class="pre">ParticleVariable</span></code>s. <code class="docutils literal notranslate"><span class="pre">ParticleVariable</span></code>s can be either <code class="docutils literal notranslate"><span class="pre">Real</span></code>-
or <code class="docutils literal notranslate"><span class="pre">int</span></code>-valued, which is specified by the metadata values
<code class="docutils literal notranslate"><span class="pre">Metadata::Real</span></code> and <code class="docutils literal notranslate"><span class="pre">Metadata::Integer</span></code>. <code class="docutils literal notranslate"><span class="pre">ParticleVariable</span></code>s
should also contain the <code class="docutils literal notranslate"><span class="pre">Metadata::Particle</span></code> flag. By default,
<code class="docutils literal notranslate"><span class="pre">ParticleVariable</span></code>s provide one scalar quantity per particle, but up
to 2D data per particle is currently supported, by passing
<code class="docutils literal notranslate"><span class="pre">std::vector&lt;int&gt;{N1,</span> <span class="pre">N2}</span></code> as the second argument to the
<code class="docutils literal notranslate"><span class="pre">ParticleVariable</span></code> <code class="docutils literal notranslate"><span class="pre">Metadata</span></code>. All <code class="docutils literal notranslate"><span class="pre">Swarm</span></code>s by default contain
<code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, and <code class="docutils literal notranslate"><span class="pre">z</span></code> <code class="docutils literal notranslate"><span class="pre">ParticleVariable</span></code>s; additional fields can
be added as:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Swarm</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">metadata</span><span class="p">)</span>
</pre></div>
</div>
<p>Instances of <code class="docutils literal notranslate"><span class="pre">MeshBlockData</span></code> own the <code class="docutils literal notranslate"><span class="pre">Swarm``s</span> <span class="pre">that</span> <span class="pre">hold</span> <span class="pre">particles</span> <span class="pre">spatially</span> <span class="pre">contained</span>
<span class="pre">by</span> <span class="pre">the</span> <span class="pre">associated</span> <span class="pre">``MeshBlock</span></code>. The <code class="docutils literal notranslate"><span class="pre">MeshBlock</span></code> is pointed to by <code class="docutils literal notranslate"><span class="pre">Swarm::pmy_block</span></code>.
<code class="docutils literal notranslate"><span class="pre">Swarm``s</span> <span class="pre">can</span> <span class="pre">be</span> <span class="pre">retrieved</span> <span class="pre">via</span> <span class="pre">both</span> <span class="pre">``MeshBlockData::GetSwarmData()</span></code> or
<code class="docutils literal notranslate"><span class="pre">MeshData::GetSwarmData(b)</span></code> where the latter returns the <code class="docutils literal notranslate"><span class="pre">Swarm``s</span> <span class="pre">associated</span> <span class="pre">with</span> <span class="pre">the</span>
<span class="pre">``MeshBlockData</span></code> pointed to by the <code class="docutils literal notranslate"><span class="pre">b</span></code> index within a <code class="docutils literal notranslate"><span class="pre">MeshData</span></code>.  We currently only
permit <code class="docutils literal notranslate"><span class="pre">Swarm``s</span> <span class="pre">to</span> <span class="pre">be</span> <span class="pre">retrieved</span> <span class="pre">from</span> <span class="pre">``&quot;base&quot;</span></code> <code class="docutils literal notranslate"><span class="pre">MeshBlockData</span></code> and <code class="docutils literal notranslate"><span class="pre">MeshData</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Swarm</span></code> is a host-side object, but some of its data members are
required for device- side compution. To access this data, a
<code class="docutils literal notranslate"><span class="pre">SwarmDeviceContext</span></code> object is created via
<code class="docutils literal notranslate"><span class="pre">Swarm::GetDeviceContext()</span></code>. This object can then be passed by copy
into Kokkos lambdas. Hereafter we refer to it as <code class="docutils literal notranslate"><span class="pre">swarm_d</span></code>.</p>
<p>To add particles to a <code class="docutils literal notranslate"><span class="pre">Swarm</span></code>, one calls</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">NewParticlesContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">swarm</span><span class="o">-&gt;</span><span class="n">AddEmptyParticles</span><span class="p">(</span><span class="n">num_to_add</span><span class="p">);</span>
</pre></div>
</div>
<p>This call automatically resizes the memory pools as necessary and
returns a <code class="docutils literal notranslate"><span class="pre">NewParticlesContext</span></code> object that provides the methods
<code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">GetNewParticlesMaxIndex()</span></code> to get the max index of the contiguous block
of indices into the swarm, and <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">GetNewParticleIndex(const</span> <span class="pre">int</span> <span class="pre">n)</span></code> to
convert a new particle index into the swarm index.</p>
<p>To remove particles from a <code class="docutils literal notranslate"><span class="pre">Swarm</span></code>, one first calls</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">swarm_d</span><span class="p">.</span><span class="n">MarkParticleForRemoval</span><span class="p">(</span><span class="n">index_to_remove</span><span class="p">)</span>
</pre></div>
</div>
<p>inside device code. This only indicates that this particle should be
removed from the pool, it does not actually update any data. To remove
all particles so marked, one then calls</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">swarm</span><span class="p">.</span><span class="n">RemoveMarkedParticles</span><span class="p">()</span>
</pre></div>
</div>
<p>in host code. This updates the swarm such that the marked particles are
seen as free slots in the memory pool.</p>
</section>
<section id="parallel-dispatch">
<h2>Parallel Dispatch<a class="headerlink" href="#parallel-dispatch" title="Link to this heading"></a></h2>
<p>Parallel computations on particle data can be performed with the usual
<code class="docutils literal notranslate"><span class="pre">MeshBlock</span></code> <code class="docutils literal notranslate"><span class="pre">par_for</span></code> calls. Typically one loops over the entire
range of active indices and uses a mask variable to only perform
computations on currently active particles:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">swarm</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">).</span><span class="n">Get</span><span class="p">();</span>
<span class="n">swarm</span><span class="p">.</span><span class="n">pmy_block</span><span class="o">-&gt;</span><span class="n">par_for</span><span class="p">(</span><span class="s">&quot;Simple loop&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">swarm</span><span class="p">.</span><span class="n">GetMaxActiveIndex</span><span class="p">(),</span>
<span class="w">  </span><span class="n">KOKKOS_LAMBDA</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">swarm_d</span><span class="p">.</span><span class="n">IsActive</span><span class="p">(</span><span class="n">n</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">x</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>
</pre></div>
</div>
</section>
<section id="sorting">
<h2>Sorting<a class="headerlink" href="#sorting" title="Link to this heading"></a></h2>
<p>By default, particles are stored in per-meshblock pools of memory.
However, one frequently wants convenient access to all the particles in
each computational cell separately. To facilitate this, the Swarm
provides the method <code class="docutils literal notranslate"><span class="pre">SortParticlesByCell</span></code> (and the <code class="docutils literal notranslate"><span class="pre">SwarmContainer</span></code>
provides the matching task <code class="docutils literal notranslate"><span class="pre">SortParticlesByCell</span></code>). Calling this
function populates internal data structures that map from per-cell
indices to the per-meshblock data array. These are accessed by the
<code class="docutils literal notranslate"><span class="pre">SwarmDeviceContext</span></code> member functions <code class="docutils literal notranslate"><span class="pre">GetParticleCountPerCell</span></code> and
<code class="docutils literal notranslate"><span class="pre">GetFullIndex</span></code>. See <code class="docutils literal notranslate"><span class="pre">examples/particles</span></code> for example usage.</p>
</section>
<section id="defragmenting">
<h2>Defragmenting<a class="headerlink" href="#defragmenting" title="Link to this heading"></a></h2>
<p>Because one typically loops over particles from 0 to
<code class="docutils literal notranslate"><span class="pre">max_active_index</span></code>, if only a small fraction of particles in that
range are active, significant effort will be wasted. To clean up these
situations, <code class="docutils literal notranslate"><span class="pre">Swarm</span></code> provides a <code class="docutils literal notranslate"><span class="pre">Defrag</span></code> method which, when called,
will copy all active particles to be contiguous starting from the 0
index. <code class="docutils literal notranslate"><span class="pre">Defrag</span></code> is not fully parallelized so should be called only
sparingly.</p>
</section>
<section id="swarmcontainer">
<h2>SwarmContainer<a class="headerlink" href="#swarmcontainer" title="Link to this heading"></a></h2>
<p>A <code class="docutils literal notranslate"><span class="pre">SwarmContainer</span></code> contains a set of related <code class="docutils literal notranslate"><span class="pre">Swarm</span></code>s, such as the
different stages used by a higher order time integrator. This feature is
currently not exercised in detail.</p>
</section>
<section id="particles-example">
<h2><code class="docutils literal notranslate"><span class="pre">particles</span></code> Example<a class="headerlink" href="#particles-example" title="Link to this heading"></a></h2>
<p>An example showing how to create a Parthenon application that defines a
<code class="docutils literal notranslate"><span class="pre">Swarm</span></code> and creates, destroys, and transports particles is available
in <code class="docutils literal notranslate"><span class="pre">parthenon/examples/particles</span></code>.</p>
</section>
<section id="communication">
<h2>Communication<a class="headerlink" href="#communication" title="Link to this heading"></a></h2>
<p>Communication of particles across <code class="docutils literal notranslate"><span class="pre">MeshBlock</span></code>s, including across MPI
processors, is supported. Particle communication is currently handled
via paired asynchronous/synchronous tasking regions on each MPI
processor. The asynchronous tasks include transporting particles and
<code class="docutils literal notranslate"><span class="pre">SwarmContainer::Send</span></code> and <code class="docutils literal notranslate"><span class="pre">SwarmContainer::Receive</span></code> calls. The
synchronous task checks every <code class="docutils literal notranslate"><span class="pre">MeshBlock</span></code> on that MPI processor for
whether the <code class="docutils literal notranslate"><span class="pre">Swarm</span></code>s are finished transporting. This set of tasks
must be repeated in the driver’s evolution function until all particles
are completed. See the <code class="docutils literal notranslate"><span class="pre">particles</span></code> example for further details. Note
that this pattern is blocking, and may be replaced in the future.</p>
<p>AMR is currently not supported, but support will be added in the future.</p>
</section>
<section id="variable-packing">
<h2>Variable Packing<a class="headerlink" href="#variable-packing" title="Link to this heading"></a></h2>
<p>Similarly to grid variables, particle swarms support
<code class="docutils literal notranslate"><span class="pre">ParticleVariable</span></code> packing, by the function <code class="docutils literal notranslate"><span class="pre">Swarm::PackVariables</span></code>.
This also supports <code class="docutils literal notranslate"><span class="pre">FlatIdx</span></code> for indexing; see the
<code class="docutils literal notranslate"><span class="pre">particle_leapfrog</span></code> example for usage.</p>
</section>
<section id="swarmpack-s">
<h2><a href="#id1"><span class="problematic" id="id2">``</span></a>SwarmPack``s<a class="headerlink" href="#swarmpack-s" title="Link to this heading"></a></h2>
<p>Similar to grid variables, swarms can be packed over <code class="docutils literal notranslate"><span class="pre">MeshBlock``s</span> <span class="pre">via</span> <span class="pre">``SwarmPack``s.</span>
<span class="pre">``SwarmPack``s</span> <span class="pre">are</span> <span class="pre">the</span> <span class="pre">particle</span> <span class="pre">analog</span> <span class="pre">to</span> <span class="pre">``SparsePack``s</span> <span class="pre">for</span> <span class="pre">field</span> <span class="pre">variables.</span>&#160; <span class="pre">A</span> <span class="pre">single</span>
<span class="pre">``SwarmPack</span></code> can contain either <code class="docutils literal notranslate"><span class="pre">int</span></code> or <code class="docutils literal notranslate"><span class="pre">Real</span></code> entries, but not both.  One can pack
a <code class="docutils literal notranslate"><span class="pre">SwarmPack</span></code> via a <code class="docutils literal notranslate"><span class="pre">std::vector&lt;std::string&gt;</span></code> or the type-based variable prescription
previously used by <a href="#id3"><span class="problematic" id="id4">``</span></a>SparsePack``s.</p>
<p>For packing via string (wherein below, <code class="docutils literal notranslate"><span class="pre">swarm_position::x::name()</span></code> returns a string),
one must specify the data type by template argument:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vars</span><span class="p">{</span><span class="n">swarm_position</span><span class="o">::</span><span class="n">x</span><span class="o">::</span><span class="n">name</span><span class="p">(),</span>
<span class="w">                              </span><span class="n">swarm_position</span><span class="o">::</span><span class="n">y</span><span class="o">::</span><span class="n">name</span><span class="p">(),</span>
<span class="w">                              </span><span class="n">swarm_position</span><span class="o">::</span><span class="n">z</span><span class="o">::</span><span class="n">name</span><span class="p">()};</span>
<span class="k">static</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MakeSwarmPackDescriptor</span><span class="o">&lt;</span><span class="n">Real</span><span class="o">&gt;</span><span class="p">(</span><span class="n">swarm_name</span><span class="p">,</span><span class="w"> </span><span class="n">vars</span><span class="p">);</span>
<span class="k">auto</span><span class="w"> </span><span class="n">pack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">desc</span><span class="p">.</span><span class="n">GetPack</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
</pre></div>
</div>
<p>For packing via type-based variables (see interface/swarm_default_names.hpp for an
example), the type can be inferred automatically:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MakeSwarmPackDescriptor</span><span class="o">&lt;</span><span class="n">swarm_position</span><span class="o">::</span><span class="n">x</span><span class="p">,</span>
<span class="w">                                           </span><span class="n">swarm_position</span><span class="o">::</span><span class="n">y</span><span class="p">,</span>
<span class="w">                                           </span><span class="n">swarm_position</span><span class="o">::</span><span class="n">z</span><span class="o">&gt;</span><span class="p">(</span><span class="n">swarm_name</span><span class="p">);</span>
<span class="k">auto</span><span class="w"> </span><span class="n">pack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">desc</span><span class="p">.</span><span class="n">GetPack</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
</pre></div>
</div>
<p>For example <code class="docutils literal notranslate"><span class="pre">SwarmPack</span></code> usage, see the <code class="docutils literal notranslate"><span class="pre">particle_leapfrog</span></code> example.</p>
</section>
<section id="boundary-conditions">
<h2>Boundary conditions<a class="headerlink" href="#boundary-conditions" title="Link to this heading"></a></h2>
<p>Particle boundary conditions are applied in per-block per-boundary kernel
launches analogous to grid-based variables. Outflow and periodic boundaries
are supported natively, but other boundary conditions (including reflecting)
must be provided by the downstream application. Particle boundary conditions are
enrolled by setting entries in <code class="docutils literal notranslate"><span class="pre">ApplicationInput::swarm_boundary_conditions</span></code>
to per-boundary (inner <code class="docutils literal notranslate"><span class="pre">x1</span></code>, outer <code class="docutils literal notranslate"><span class="pre">x2</span></code>, etc.) custom boundary functions
with signature</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">SwarmUserInnerX1</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Swarm</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">swarm</span><span class="p">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">particles</span></code> example demonstrates how to create and enroll custom particle
boundary conditions.</p>
<p>Note that periodic boundary conditions cannot be enrolled by the user; the
default <code class="docutils literal notranslate"><span class="pre">periodic</span></code> option for Parthenon must be requested in the input file.</p>
</section>
<section id="outputs">
<h2>Outputs<a class="headerlink" href="#outputs" title="Link to this heading"></a></h2>
<p>Outputs for swarms can be set in an output block, just like any other
variable. The user must specify a comma separated list denoting which
swarms are marked for output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">swarms</span> <span class="o">=</span> <span class="n">swarm1</span><span class="p">,</span> <span class="n">swarm2</span><span class="p">,</span> <span class="o">...</span>
</pre></div>
</div>
<p>By default every swarm is initialized with <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, and <code class="docutils literal notranslate"><span class="pre">z</span></code>
position variables. These are automatically output.</p>
<p>To specify additional outputs, one may add an additional comma
separated list:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">swarmname_variables</span> <span class="o">=</span> <span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">,</span> <span class="o">...</span>
</pre></div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">swarmname</span></code> is the name of the swarm in question, and <code class="docutils literal notranslate"><span class="pre">var1</span></code>,
<code class="docutils literal notranslate"><span class="pre">var2</span></code>, etc., are the variables to output for that particular
swarm. You may still specify <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, and <code class="docutils literal notranslate"><span class="pre">z</span></code>, but specifying
them is superfluous as they are automatically output for any swarm
that is output.</p>
<p>Alternatively, you may provide the</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">swarm_variables</span> <span class="o">=</span> <span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">,</span> <span class="o">...</span>
</pre></div>
</div>
<p>input as a comma separated list. This will output each variable in the
<code class="docutils literal notranslate"><span class="pre">swarm_variables</span></code> list for <strong>every</strong> swarm. This is most useful if
all the swarms contain similar variable structure, or if you only have
one swarm to output. The per-swarm lists can be composed with the
<code class="docutils literal notranslate"><span class="pre">swarm_variables</span></code> field. Every swarm will output the vars in
<code class="docutils literal notranslate"><span class="pre">swarm_variables</span></code> but then <strong>additionally</strong> the variables in a
per-swarm list will be output for that swarm.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some visualization tools, like Visit and Paraview, prefer to have
access to an <code class="docutils literal notranslate"><span class="pre">id</span></code> field for each particle, however it’s not clear
that a unique ID is required for each particle in
general. Therefore, swarms do not automatically contain an ID swarm
variable. However, when Parthenon outputs a swarm, it automatically
generates an ID variable even if one is not present or
requested. If a variable named <code class="docutils literal notranslate"><span class="pre">id''</span> <span class="pre">is</span> <span class="pre">available</span> <span class="pre">**and**</span> <span class="pre">the</span> <span class="pre">user</span>
<span class="pre">requests</span> <span class="pre">it</span> <span class="pre">be</span> <span class="pre">output,</span> <span class="pre">Parthenon</span> <span class="pre">will</span> <span class="pre">use</span> <span class="pre">it.</span> <span class="pre">Otherwise,</span> <span class="pre">Parthenon</span>
<span class="pre">will</span> <span class="pre">generate</span> <span class="pre">an</span> <span class="pre">``id</span></code> variable just for output and write it to
file.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The automatically generted <code class="docutils literal notranslate"><span class="pre">id</span></code> is unique for a snapshot in time,
but not guaranteed to be time invariant. Indeed it is likely
<strong>not</strong> the same between dumps.</p>
</div>
<p>Putting it all together, you might have an output block that looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">parthenon</span><span class="o">/</span><span class="n">output1</span><span class="o">&gt;</span>
<span class="n">file_type</span> <span class="o">=</span> <span class="n">hdf5</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">swarms</span> <span class="o">=</span> <span class="n">swarm1</span><span class="p">,</span> <span class="n">swarm2</span>
<span class="n">swarm_variables</span> <span class="o">=</span> <span class="n">shared_var</span>
<span class="n">swarm1_variables</span> <span class="o">=</span> <span class="n">per_swarm_var</span>
<span class="n">swarm2_variables</span> <span class="o">=</span> <span class="nb">id</span>
</pre></div>
</div>
<p>The result would be that both <code class="docutils literal notranslate"><span class="pre">swarm1</span></code> and <code class="docutils literal notranslate"><span class="pre">swarm2</span></code> output the
variables <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, <code class="docutils literal notranslate"><span class="pre">z</span></code>, and <code class="docutils literal notranslate"><span class="pre">shared_var</span></code>. But only <code class="docutils literal notranslate"><span class="pre">swarm1</span></code>
outputs <code class="docutils literal notranslate"><span class="pre">per_swarm_var</span></code>. Both <code class="docutils literal notranslate"><span class="pre">swarm1</span></code> and <code class="docutils literal notranslate"><span class="pre">swarm2</span></code> will output
an <code class="docutils literal notranslate"><span class="pre">id</span></code> field. But the <code class="docutils literal notranslate"><span class="pre">id</span></code> field for <code class="docutils literal notranslate"><span class="pre">swarm1</span></code> will be
automatically generated, but the <code class="docutils literal notranslate"><span class="pre">id</span></code> field for <code class="docutils literal notranslate"><span class="pre">swarm2</span></code> will use
the user-initialized value if such a quantity is available.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="parthenon_manager.html" class="btn btn-neutral float-left" title="Parthenon Manager" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="reductions.html" class="btn btn-neutral float-right" title="Task-based reductions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, The Parthenon Collaboration and Triad National Security.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: acreyes/edge-flux-pack
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Branches</dt>
      <dd><a href="../../../develop/src/particles.html">develop</a></dd>
      <dd><a href="../../div-free-prolong/src/particles.html">acreyes/div-free-prolong</a></dd>
      <dd><a href="particles.html">acreyes/edge-flux-pack</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>